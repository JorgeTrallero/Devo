<html>
<head>

<script src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/data.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<body>
	  <div id = "container" ></div>
	  <div id = "containerPie"></div>
<script>

var sortByProperty = function (property) {

    return function (x, y) {

        return ((x[property] === y[property]) ? 0 : ((x[property] > y[property]) ? 1 : -1));

    };

};

function add(a, b) {
    return a + b;
}


var LineLabels=[];
var CAT1=[];
var CAT2=[];
var CAT3=[];
var CAT4=[];
var final_data = [] ;


GetData();
function GetData(){
var data = [] ;
const monthNames = ["Jan", "Feb", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
var i= 0;
//CARGA DATOS PRIMER FICHERO			
	$.ajax({
	type : "GET",
	url: 'http://s3.amazonaws.com/logtrust-static/test/test/data1.json',
	dataType : 'json',
	'success' : function(response) {						
	    
		
		response.forEach(function (x){
			var newjson={};
			newjson.d=x.d;
			x.d=new Date(x.d);
			newjson.timeD_M = (x.d).getDate() + "." + monthNames[(x.d).getMonth()];
			newjson.cat=(x.cat).toUpperCase();
			newjson.val=x.value;
			data[i]=(newjson);
			i++;
		})
	 	
	},
	error : function(req, status, err) {
		console.log('something went wrong',req.responseText, status, err);
	},
	complete: function () {
	$.ajax({
		type : "GET",
		url: 'http://s3.amazonaws.com/logtrust-static/test/test/data2.json',
		dataType : 'json',
		'success' : function(response) {						
			
			response.forEach(function (x){
				var newjson={};
				x.myDate=new Date(x.myDate);
				newjson.d=(x.myDate).getTime();
				newjson.timeD_M = (x.myDate).getDate() + "." + monthNames[(x.myDate).getMonth()];
				newjson.cat=x.categ;
				newjson.val=x.val;
				data[i]=(newjson);
				i++;
			
			})
		
		
			},
			error : function(req, status, err) {
			console.log('something went wrong',req.responseText, status, err);
			},
			complete: function () {
				var regexCAT = /\C\A\T\s\d/;
				var regexDate = /(\d{4})[-](\d{2})[-](\d{2})/;
				$.ajax({
					type : "GET",
					url: 'http://s3.amazonaws.com/logtrust-static/test/test/data3.json',
					dataType : 'json',
					'success' : function(response) {						
						var newjson={};
						response.forEach(function (x){
							var time=(x.raw).match(regexDate)[0];
							time=new Date(time);
							newjson.d=(time).getTime();
							newjson.timeD_M = (time).getDate() + "." + monthNames[(time).getMonth()];
							newjson.cat=((x.raw).match(regexCAT)[0]);
							newjson.val=x.val;
							data[i]=(newjson);
							i++;
							
						})
						
						
				
					},
					error : function(req, status, err) {
						console.log('something went wrong',req.responseText, status, err);
					},
					complete: formatData(data)
				});
			}
		});
     }
}
);	



	
		

}




function formatData(data){	
		data.sort(sortByProperty('d'));
		data.sort(sortByProperty('cat'));
		var jsondata={};
		
		data.forEach(function (x){
			
	
			if(x.timeD_M==jsondata.timeD_M && x.cat==jsondata.cat ){
				jsondata.val+=x.val;
				
			}else {
				final_data.push(jsondata);
				jsondata=x;

		} })
		
		final_data.sort(sortByProperty('d'));
		var timelabel="";
		final_data.forEach(function (x){
			if(timelabel!=x.timeD_M){
				LineLabels.push(x.timeD_M);
				timelabel=x.timeD_M;
			}
			if(x.cat=="CAT 1"){
				CAT1.push(x.val);
			}
			if(x.cat=="CAT 2"){
				CAT2.push(x.val);
			}
			if(x.cat=="CAT 3"){
				CAT3.push(x.val);
			}
			if(x.cat=="CAT 4"){
				CAT4.push(x.val);
			}
		})

		Linechart();
		Piechart();
		
}
      
function Linechart(){		  
	$(document).ready(function() {
		var title = {
		text: 'Test  Line'   
		};
		var subtitle = {
		text: 'Devo'
		};
		var xAxis = {
		categories: LineLabels
		};
		var yAxis = {
		title: {
			text: 'total'
		},
		plotLines: [{
			value: 0,
			width: 1,
			color: '#808080'
		}]
		};   
		var tooltip = {
		valueSuffix: '\xB0C'
		}
		var legend = {
		layout: 'vertical',
		align: 'right',
		verticalAlign: 'middle',
		borderWidth: 0
		};
		var series =  [{
			name: 'CAT 1',
			data: CAT1
		}, 
		{
			name: 'CAT 2',
			data: CAT2
		},
		{
			name: 'CAT 3',
			data: CAT3
		},
		{
			name: 'CAT 4',
			data: CAT4
		}
		];
	
		var json = {};
		json.title = title;
		json.subtitle = subtitle;
		json.xAxis = xAxis;
		json.yAxis = yAxis;
		json.tooltip = tooltip;
		json.legend = legend;
		json.series = series;
		
		$('#container').highcharts(json);
	});
}

function Piechart(){	
   $(document).ready(function() {
            var chart = {
               plotBackgroundColor: null,
               plotBorderWidth: null,
               plotShadow: false
            };
            var title = {
               text: 'Test PIE'   
            };
            var tooltip = {
               pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            };
            var plotOptions = {
               pie: {
                  allowPointSelect: true,
                  cursor: 'pointer',
                  
                  dataLabels: {
                     enabled: true,
                     format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                     style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor)||
                        'black'
                     }
                  }
               }
            };
            var series = [{
               type: 'pie',
               name: 'Browser share',
               data: [
                  ['CAT 1', CAT1.reduce(add, 0)],
                  ['CAT 2', CAT2.reduce(add, 0)],
                  ['CAT 3', CAT3.reduce(add, 0)],
                  ['CAT 4', CAT4.reduce(add, 0)]
               ]
            }];
            var json = {};   
            json.chart = chart; 
            json.title = title;     
            json.tooltip = tooltip;  
            json.series = series;
            json.plotOptions = plotOptions;
            $('#containerPie').highcharts(json);  
         });
}
</script>
</body>
</html>